# Troubleshooting Guide

## Общие проблемы и решения

### 1. Проблемы с генерацией музыки

#### Задачи застревают в статусе "processing"
**Симптомы:**
- Задача генерации не завершается более 15 минут
- Прогресс остается на одном уровне
- Нет обновлений в real-time

**Решения:**
1. Используйте функцию очистки застрявших задач:
   ```typescript
   const { data, error } = await supabase.functions.invoke('cleanup-stuck-tasks');
   ```

2. Проверьте логи Suno API в админ панели

3. Перезапустите генерацию с теми же параметрами

#### Ошибки Suno API
**Симптомы:**
- Ошибки 404 или 500 от Suno API
- Таймауты при обращении к API
- Неверные данные в callback

**Решения:**
1. Проверьте статус Suno API: https://status.suno.ai
2. Убедитесь, что API ключ валиден
3. Проверьте лимиты API
4. Попробуйте другой модель (V4 вместо V4_5)

### 2. Проблемы с интерфейсом

#### Кнопки выходят за границы на мобильных устройствах
**Симптомы:**
- Кнопки обрезаются на краях экрана
- Текст не помещается в кнопки
- Элементы интерфейса перекрывают друг друга

**Решения:**
1. Обновите до последней версии компонентов
2. Проверьте CSS классы для responsive дизайна
3. Используйте `flex-1 sm:flex-none` для кнопок
4. Добавьте `min-w-0` для предотвращения переполнения

#### Проблемы с отображением на разных устройствах
**Симптомы:**
- Интерфейс выглядит по-разному на разных устройствах
- Элементы не адаптируются к размеру экрана

**Решения:**
1. Используйте Tailwind responsive prefixes (`sm:`, `md:`, `lg:`)
2. Проверьте viewport meta tag в HTML
3. Тестируйте на разных размерах экрана

### 3. Проблемы с аутентификацией

#### Ошибки "Unauthorized"
**Симптомы:**
- 401 ошибки при обращении к API
- Пользователь не может генерировать музыку
- JWT токен не работает

**Решения:**
1. Проверьте, что пользователь авторизован:
   ```typescript
   const { data: { user } } = await supabase.auth.getUser();
   if (!user) {
     // Пользователь не авторизован
   }
   ```

2. Обновите токен:
   ```typescript
   await supabase.auth.refreshSession();
   ```

3. Проверьте настройки RLS в Supabase

### 4. Проблемы с базой данных

#### RLS Policy нарушения
**Симптомы:**
- Ошибки "new row violates row-level security policy"
- Не удается вставить или обновить данные

**Решения:**
1. Убедитесь, что `user_id` устанавливается правильно:
   ```typescript
   const { data, error } = await supabase
     .from('generation_jobs')
     .insert({
       user_id: user.id, // Обязательно!
       // другие поля...
     });
   ```

2. Проверьте политики RLS в Supabase Dashboard

#### Проблемы с migration
**Симптомы:**
- Ошибки при выполнении SQL миграций
- Функции не создаются

**Решения:**
1. Проверьте синтаксис SQL
2. Убедитесь, что все зависимости существуют
3. Выполняйте миграции пошагово

### 5. Проблемы с производительностью

#### Медленная загрузка
**Симптомы:**
- Долгая загрузка страницы
- Медленные запросы к API

**Решения:**
1. Оптимизируйте запросы к базе данных
2. Используйте индексы для часто запрашиваемых полей
3. Кэшируйте статические данные
4. Реализуйте lazy loading для больших списков

#### Проблемы с real-time обновлениями
**Симптомы:**
- Не приходят уведомления об обновлениях
- Задержки в получении данных

**Решения:**
1. Проверьте настройки Supabase Realtime
2. Убедитесь, что подписка активна:
   ```typescript
   const subscription = supabase
     .channel('generation-jobs')
     .on('postgres_changes', {
       event: 'UPDATE',
       schema: 'public',
       table: 'generation_jobs'
     }, (payload) => {
       console.log('Update received:', payload);
     })
     .subscribe();
   ```

### 6. Отладка

#### Как включить подробные логи
1. Откройте DevTools (F12)
2. Перейдите на вкладку Console
3. Включите все уровни логирования
4. Проверьте Network tab для API запросов

#### Полезные команды для отладки
```typescript
// Проверка состояния аутентификации
console.log('User:', await supabase.auth.getUser());

// Проверка соединения с базой данных
console.log('DB Test:', await supabase.from('generation_jobs').select('count').single());

// Проверка Edge Functions
console.log('Function Test:', await supabase.functions.invoke('test-auth'));
```

## Система мониторинга

Используйте компонент `GenerationMonitor` для отслеживания:
- Статистики выполнения задач
- Выявления застрявших задач
- Анализа производительности
- Мониторинга ошибок

## Логи и метрики

### Где найти логи
1. **Supabase Dashboard** → Functions → Logs
2. **Browser DevTools** → Console
3. **Network requests** → Response данные

### Ключевые метрики для мониторинга
- Время выполнения генерации
- Процент успешных генераций
- Количество застрявших задач
- Использование API лимитов

## Профилактика проблем

### Регулярное обслуживание
1. Запускайте очистку застрявших задач каждые 30 минут
2. Мониторьте использование API лимитов
3. Проверяйте логи на наличие ошибок
4. Обновляйте зависимости

### Рекомендуемые настройки
1. Установите таймауты для API запросов
2. Реализуйте retry логику
3. Используйте connection pooling
4. Настройте алерты для критических ошибок

## Контакты для поддержки

Если проблема не решается:
1. Проверьте документацию API
2. Изучите примеры кода
3. Обратитесь к сообществу разработчиков
4. Создайте issue в репозитории проекта